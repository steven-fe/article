<!-- 因为对于gitlab flow和trunk base development 没有实际的体验。这里写的说明全从网上摘取的。
所以这个文章，暂时先搁置一下。等待有经验了，再继续完成。 -->

# git 常用的分支管理模型

git 是目前最流行的代码管理工具。在 git 上创建分支，让不同的开发者并行开发代码。

git 提供了管理分支、合并代码等管理代码的命令，但并没有提供分支管理模型。当团队规模较小，代码的迭代不是很频繁的情况下，分支管理模型的优劣不是很明显。但当团队规模较大，需求迭代很频繁时，一个合适的分支管理模型将尤其重要。

没有一个完美的分支管理模型，需要根据项目的特点、团队的特点选择适合的分支管理模型。

接下来介绍几个使用度较高的分支管理模型。

## git-flow

在2010年，Vincent Driessen 推出了 git-flow 分支管理模型。该分支管理模型使得版本库的演进保持简洁，主干清晰，各个分支各司其职、井井有条。其结构图如下所示。

<p align="center"><img style="background-color: #fff;" src="./2.awebp"></p>

`git-flow` 主要包含以下分支

<!-- - `master` 是长期分支。由该分支部署代码至生产环境。使用tag版本号管理生产环境的历史版本。 -->
- `master` 是长期分支。由该分支部署代码至生产环境。
- `develop` 是长期分支。日常开发的代码都会汇总到该分支。
- `feature` 是短期分支。用于一个新功能的开发。
- `hotfix` 是短期分支。用于快速修复生产环境的bug。
<!-- - `hotfix` 是短期分支。当生产环境出现bug时，从master分支创建一个hotfix分支，进行bug修复。 -->
- `release` 是短期分支。用于将代码部署至生产环境前的预发测试阶段。
<!-- - `release` 是短期分支。用于发布正式版本之前（即合并到 master 分支之前），需要对预发布的版本进行测试。 -->

### 工作流程

#### 版本开发

git-flow适用于`版本发布`的产品迭代场景。在产品迭代前，需要确定下一个版本的所有开发内容。

1. 从develop分支创建feature分支，进行代码的编写工作；编写代码工作完成后，将feature分支合并到develop分支。

2. 在版本开发截止日，将该版本的所有feature分支合并到develop分支上；然后从develop分支上创建一个release分支，进入预发环境的测试。

3. 在预发环境，对release分支进行充分地测试；如果在测试过程中发现bug，则在release分支上进行修复；

4. 测试结束后，将release分支合并到master分支和develop分支；然后在master分支创建版本tag，并且以该tag进行生产环境的代码部署。

以上的步骤结束后，整个版本的完整周期就结束了，可以进行下一个版本的开发。

#### 生产环境的bug修复

1. 当需要修复生产环境的bug时，需要从master分支创建hotfix分支，在该分支上进行bug的修复工作。

2. 当修复工作完成后，将hotfix分支合并到master分支和develop分支。

3. 在master分支上创建当前版本的小版本tag（例如，当前版本为1.0.0，升级小版本后是1.0.1），然后以该tag进行生产环境的代码部署。

### 特点

分支结构清晰，每个分支的任务划分的很清楚。

### 缺点

git-flow适用于`版本发布`的产品迭代场景，不适用于`持续发布`的产品迭代场景。

> 在网站项目中，有时候修改一个文案，就需要部署代码至生产环境。如果使用git-flow完成这个修改，则流程显得过于繁琐。

## GitHub flow

<p align="center"><img style="background-color: #fff;" src="./1.awebp"></p>

GitHub flow 是 GitHub 官方推荐的开发流程。以快速部署为目标，目前大部分开源项目（library or framework）都遵循这一流程。

Github flow 是 Github 推出的一种简便、敏捷并适合快速持续部署项目的分支管理策略，该工作流只有一条长期分支 —— `master分支`。具体使用步骤如下：

1. 从master分支`创建一个新分支`，进行代码的编写工作（不区分feature分支或hotfix分支，因为流程都一样）。

2. 在新分支上，`提交修改`到远程代码仓库。

3. 当编写代码工作完成后，为了让代码合并到master分支，`创建一个 Pull Request`。

4. 在发起Pull Request之后，项目相关人员将对新分支代码进行讨论和代码审查；如果代码有问题，则需要在新分支上做修改，然后再重新进行该步骤，直到通过`代码评审`。

5. 将新分支`部署`到测试环境，进行自动化测试；如果代码测试不通过，则需要修复相关代码，提交修改到远程代码仓库，然后重新回到第四步。

6. 当被编写的代码通过测试，则Pull Request将被通过，被编写的代码就可以合并到master分支了，等待代码发布至生产环境。

### 特点

1. 流程简单灵活，只有一个长期分支——`主分支master`，不需要考虑以及管理太多的分支。
2. 适合于需要快速“持续发布”的项目。

### 缺点

1. 对于应用场景比较复杂的情况，例如：多个环境下的代码部署，多个版本的管理等等。只有一个master分支便会显得力不从心。
2. 在测试阶段，依赖于自动化测试，对代码贡献者的素质要求较高。

## GitLab flow

GitLab flow 是 Git-flow与Github flow的综合。它吸取了两者的优点，既有适应不同开发环境的弹性，又有单一主分支的简单和便利。它是Gitlab.com推荐的做法。

Gitlab flow的最大原则叫做”上游优先”（upstream first），即只存在一个主分支master，它是所有其他分支的”上游”。只有上游分支采纳的代码变化，才能应用到其他分支。

Gitlab flow分为持续发布与版本发布两种情况，以适应不同的发布类型

### 持续发布

<p align="center"><img style="background-color: #fff;" src="./3.awebp"></p>

根据实际需要，在master分支以外，建立不同环境的分支。比如，“开发环境”的分支是`master`，“预发环境”的分支是`pre-production`，“生产环境”的分支是`production`。

`master`分支是`pre-production`分支的“上游”，`pre-production`分支是`production`分支的“上游”，以此类推。

代码的变化，必须由“上游”向“下游”发展。比如，生产环境出现了bug，需要在先在`master`分支上修复该问题，确认没问题后，再将代码合并到下游的`pre-production`分支。这一步也没有问题，才进入`production`分支。

### 版本发布

<p align="center"><img style="background-color: #fff;" src="./4.awebp"></p>

对于"版本发布"的项目，建议的做法是每一个稳定版本，都要从master分支拉出一个分支，比如2-3-stable、2-4-stable等等。

以后，只有修补bug，才允许将代码合并到这些分支，并且此时要更新小版本号。

## Trunk-based Development

<p align="center"><img style="background-color: #fff;" src="./5.awebp"></p>

Trunk-based Development是一种更加敏捷的git分支管理模型。其核心思想是：

1. 拆分任务 —— 将开发任务拆分成若干个至少一天可以提交一次“merge request”级别的微任务。

2. 降低合并复杂度 —— 由于每个任务开发量较小，code review和ci的复杂度会降低，时间都会缩短。

### 主要流程

1. 在直接在trunk分支进行持续的开发任务、修复bug任务。

2. 当所有的开发任务结束时，则创建一个release分支，部署至预发环境进行上线前的测试流程。
    - 如果在预发环境发现bug，则需要在trunk分支上进行修复，然后将修复bug的commit cherry-pick到release分支上。

3. 当release分支在预发环境测试通过后，直接将release分支部署到生产环境。

### 特点

通过拆分任务的方式，实现了敏捷开发，降低了合并的复杂度与风险（可能开发了很长一段时间，代码丢失，导致无法合并到主分支）。

### 缺点

开发人员的素质要求较高：如果开发人员素质偏低，可能某次提交的代码有重大bug；可能导致整个trunk分支被暂停，无法提交commit，等着修复bug。

要求有“全面的自动化测试”：只有在本地通过”全面的自动化测试“，才能保证提交的代码是基本可靠的，不会出现阻塞整个trunk分支提交commit的流程。

## 总结

